# Сarhud Black Pearl
Scripts and setting for black pearl car HUD. 

Скрипты и конфигурации для построения дополнительных приборных индикаторов на базе телефонов в нормальном и HUD-режиме. Часть пидов взяты для Hyundai Creta, можно адаптировать и для других машин

## Архитектура системы

На машине установлена Android-магнитола и по USB подключен ELM/ODB II адаптер, данные отображаются в программе Torque. Стоит задача отобразить нужные показатели - скорость и температуры основных жидкостей на Android устройствах, включенных в общую вайфай сеть с магнитолой.
Вся обработка данных делается в программе Node-Red, отображение так же осуществляется в Node-Red Dashboard 2.0 с поддержкой двух горизонтальной и вертикальной ориентации, при этом горизонтальная ориентация расчитана на "HUD устройство" и зеркально отражает изображение.
Предложено две схемы работы: основная - с использованием MQTT и резервная, с ипользованием https. Реальные испытания показали, что https схеме неработоспособна из-за ошибок в ПО Torque. 

## Основаная схема

В основном варианте данные проходят через следующие программы:

- Torque
- Torque Plugin For Tasker
- Macrodroid
- Mqtt Publisher Plugin for Tasker
- NodeRed (Mqtt Input)
- Browser на Android телефоне или PWA приложение

  Проограммы Tasker и Macrodoid имеют совместимый интерфейс, и плагины будут работать. Можно взять таскер, но к Macrodoid проще найти работающую версию.

### Особенности реализации

Torque Plugin For Tasker своеобразно номерует ПИДы в виде пары чисел, соединенных запятой. Для стандартных пидов первое число это и есть настоящий PID (скорость -0d), второе число это 0. Для кастомных пидов первое число это сам PID, второе вычисляется неясным образом. Потому в реализации для общности с HTTP:
- разделитель "," заменяется на 0 еще в самом Macrodroid
- у кастномных пидов второе число отрезается и заменяется на 0
- для стандарных пидов, начинающихся с 0 он отрезается

  MQTT топики имеют вид: creta/carhud/torque/%pidid

  Если данные пришли с меткой времени старше 15 секунд - они выбрасываются.
  
## Резервная схема

  В резервной схеме используется способность программы Torque загружать значения ПИД через http GET запрос. Данные проходят через следующие программы:
  
- Torque
- NodeRed (Http In)
- Browser на Android телефоне или PWA приложение

### Особенности реализации

  Torque присылает значения всех типов пидов в виде "k%PID", поэтому k отрезается и _0 приклеивается. Так же Torque может накопиь данные и начать их присылать в странном порядке, поэтому необходимо проверять, что данные новее тех, что уже были присланы. Так же если данные пришли с меткой времени старше 15 секунд - они выбрасываются. С помощью таймера было организовано слежение за отсутсвием данных в течении 5 секунд, если такое случается, то отображается надпись "УСТ" желтого цвета. Этот механизм не работает для MQTT, где данные присылаются толкьо по изменению. 

  По какой-то причине Torque шлет данные с рандомном порядке, причем повторяет ранее присланные данные из прошлого и нарушает порядок до полной неработоспособности решения. Возможно, ему не нравится 200 OK, присылаемые Node-Red.

## Отображение

Все 4 параметра отображаются в простой grid-layout странице, расчитаной на Galaxy A51. Есть кнопка перехода в fullscreen режим, причем для нормальной ориентации она переключает режимы, а для HUD ориентации натажие на кнопку всегда переключает в HUD режим, а нажатие на другое место экрана возвращает обратно, потому что в HUD режиме целиться в кнопку затруднительно. К несчастью, браузеры запрещают установку полноэкранного режима обычным страницам без действий пользователся потому приходится нажимать кнопки. Так же желательно включить темную тему на устройстве.
Для каждого параметра (кроме скорости), заданы верхние и нижние пределы. Норма отображается белым, превышение - красным, понижение - голубым.

### PWA

Для автоматического перехода в fullscreen нужно устаносить PWA приложение. Для этого сделайте следующие действия:
  - установите nginx
  - создайте самомодписанный сертификат, предварительно настроев его на адрес магнитолы. скрипты в папке certs
  - настройте https конфигурацию nginx и файл с изменынным манифестом приложения со скриншотами
  - откройте dashboard в телефонном браузере через HTTPS и установите PWA приложение его на телефоне

  (конфигурация будет выложена позднее)
  
